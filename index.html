<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>PODRIDA CALCULATOR</title>
  <style>
    :root{
      --bg:#000531;
      --border: rgba(255,255,255,.18);
      --grid: rgba(255,255,255,.12);
      --text:#ffffff;

      --pidioBg: rgba(255,255,255,.10);
      --llevoBg: rgba(110,200,255,.18);

      --turnBg: rgba(255, 183, 0, 0.9);
      --turnOutline: rgba(0,0,0,.25);

      --roundBg: rgba(255,255,255,.10);
      --muted: rgba(255,255,255,.75);
    }

    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      margin: 5px;
      background: var(--bg);
      color: var(--text);
    }

    .wrap{ max-width:1750px; margin:0 auto; padding:50px; }

    .titleBar{
      width:100%;
      display:flex;
      justify-content:center;
      margin:100px 0 5px 0;
    }
    .title{
      font-size:100px;
      font-weight:1000;
      letter-spacing:.8px;
      text-align:center;
      padding:8px 14px;
      border-radius:30px;
      background: rgba(12, 55, 58, 0);
      border:0px solid var(--border);
    }

    .subtitle{
      width:100%;
      display:flex;
      justify-content:center;
      margin:14px 0 100px 0;
      font-size: 50px;
      font-weight:100;
      letter-spacing:.8px;
      text-align:center;
      padding:8px 14px;
      border-radius:30px;
      background: rgba(139, 42, 42, 0);
      border:0px solid var(--border);
    }

    .piepag{
      width:100%;
      display:flex;
      justify-content:left;
      margin:5px 0 5px 0;
      font-size:40px;
      font-weight:100;
      letter-spacing:.8px;
      text-align:left;
      padding:8px 14px;
      border-radius:30px;
      background: rgba(12, 55, 58, 0);
      border:0px solid var(--border);
    }

    .instrucciones{
      width:100%;
      display:flex;
      justify-content:left;
      margin:5px 0 5px 0;
      font-size:35px;
      font-weight:100;
      letter-spacing:.8px;
      text-align:left;
      padding:8px 14px;
      border-radius:30px;
      background: rgba(12, 55, 58, 0);
      border:0px solid var(--border);
    }
    .instru2{
      width:100%;
      display:flex;
      justify-content:left;
      margin:5px 0 70px 0;
      font-size:35px;
      font-weight:100;
      letter-spacing:.8px;
      text-align:left;
      padding:8px 14px;
      border-radius:30px;
      background: rgba(12, 55, 58, 0);
      border:0px solid var(--border);
    }

    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:20px;
    }
    button{
      padding:9px 14px;
      border:1px solid var(--border);
      border-radius:30px;
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-size:18px;
    }
    button:hover{ background: rgba(255, 255, 255, 0.1); }
    small{ color: var(--muted); }

    /* Selector de jugadores */
    .playersControl{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border:1px solid var(--border);
      border-radius:30px;
      background: rgba(255,255,255,.04);
    }
    .playersControl label{
      font-size:18px;
      font-weight:900;
      color: rgba(255,255,255,.92);
      white-space:nowrap;
    }
    .playersControl select{
      height:40px;
      min-width:110px;
      border-radius:18px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:1000;
      font-size:18px;
      padding:0 12px;
      outline:none;
    }

    .layout{
      display:grid;
      grid-template-columns: 1fr 700px;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 1200px){
      .layout{ grid-template-columns: 1fr; }
    }

    table.main{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      border:2px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      overflow:hidden;
    }
    table.main th, table.main td{
      border:1px solid var(--grid);
      height:40px;
      padding:8px 8px;
      vertical-align:middle;
      font-size:25px;
      color: var(--text);
    }
    table.main thead th{
      font-weight:900;
      background: rgba(255,255,255,.06);
    }

    col.cc { width: 180px; }
    col.pidio { width: 85px; }
    col.llevo { width: 80px; }
    col.puntos { width: 140px; }

    .sepL{ border-left:2px solid var(--border) !important; }
    .sepR{ border-right:2px solid var(--border) !important; }
    .topThick{ border-top:2px solid var(--border) !important; }
    .bottomThick{ border-bottom:2px solid var(--border) !important; }

    .nameInput{
      width:100%;
      box-sizing:border-box;
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px 10px;
      font-weight:1000;
      font-size:50px;
      background: rgba(255,255,255,.06);
      color: var(--text);
      text-align:center;
      outline:none;
    }

    .roundInput{
      width:100%;
      box-sizing:border-box;
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 10px;
      font-weight:1000;
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      transition: font-size .15s ease, transform .15s ease, opacity .15s ease, background .15s ease;
      font-size:11px;
      opacity:.70;
    }
    .roundInput.roundActiveBig{
      font-size:40px;
      opacity:1;
      transform: scale(1.03);
      background: rgb(71, 221, 255);
    }
    .roundInput.roundNextBig{
      font-size:20px;
      opacity:.95;
      background: rgba(255,255,255,.10);
    }

    select{
      width:100%;
      height:34px;
      border-radius:12px;
      border:1px solid var(--border);
      padding:2px 10px;
      background: rgba(255,255,255,.06);
      color: var(--text);
      transition: background .15s ease, box-shadow .15s ease;
      outline:none;
    }
    option{ color:#000000; }

    select.pidioSel{ background: var(--pidioBg); }
    select.llevoSel{ background: var(--llevoBg); }

    select.turnActive{
      background: var(--turnBg) !important;
      color:#111;
      box-shadow: 0 0 0 3px var(--turnOutline);
      border-color: rgba(0,0,0,.25);
      font-weight:1000;
    }

    td.roundActive{ background: var(--roundBg); }

    .pts{
      text-align:center;
      font-weight:1000;
      letter-spacing:.3px;
    }
    .pts.neg{ color:#ff0000; }
    .pts.pos{ color:#00ff04; }

    .pts.turnText{
      color:#fff700;
      font-weight:1100;
      text-transform:uppercase;
      font-size:12px;
      letter-spacing:.6px;
    }
    .pts.dealerText{
      color:#ff9557;
      font-weight:1100;
      text-transform:uppercase;
      font-size:12px;
      letter-spacing:.6px;
    }

    tfoot td{
      height:64px;
      font-size:18px;
      font-weight:1100;
      background: rgba(255,255,255,.06);
      border-top:2px solid var(--border) !important;
    }
    .totalLabel{ text-align:left; padding-left:12px; }
    .totalBox{ text-align:center; }

    .forcedHint{
      box-shadow: 0 0 0 2px rgba(255,255,255,.12) inset;
    }

    /* Leaderboard (lista ordenada) */
    .scoreboard{
      border:10px solid var(--border);
      border-radius:14px;
      background: rgba(35, 75, 72, 0.493);
      overflow:hidden;
      position:sticky;
      top:10px;
    }
    .scoreboardHeader{
      padding:16px 14px;
      background: rgba(255,255,255,.06);
      font-weight:1000;
      letter-spacing:.4px;
      font-size:26px;
    }
    .scoreList{
      padding:14px;
      display:grid;
      gap:10px;
    }
    .scoreItem{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 14px;
      border:1px solid var(--grid);
      border-radius:18px;
      background: rgba(255,255,255,.05);
      font-weight:1000;
      font-size:26px;
    }
    .scoreItem .left{
      display:flex;
      gap:12px;
      align-items:center;
      min-width:0;
    }
    .rank{
      width:44px;
      height:44px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid var(--grid);
      background: rgba(255,255,255,.06);
      font-weight:1100;
      flex:0 0 auto;
    }
    .scoreItem .name{
      color: rgba(255,255,255,.95);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .scoreItem .ptsVal{
      color: rgba(255,255,255,.98);
      white-space:nowrap;
    }

    .results{
      margin-top:16px;
      padding:18px;
      border:1px solid var(--border);
      border-radius:16px;
      background: rgba(255,255,255,.05);
      display:none;
    }
    .results.show{ display:block; }
    .results h2{
      margin:0 0 10px 0;
      font-size:26px;
      font-weight:1100;
      letter-spacing:.4px;
    }
    .winner{
      font-size:50px;
      font-weight:1100;
      margin:8px 0;
    }
    .second{
      font-size:40px;
      font-weight:1000;
      margin:6px 0;
      color: rgba(255,255,255,.92);
    }
    .third{
      font-size:30px;
      font-weight:950;
      margin:6px 0;
      color: rgba(255,255,255,.86);
    }
    .rowLine{
      display:flex;
      justify-content:space-between;
      gap:14px;
      font-weight:900;
      color: rgba(255,255,255,.82);
    }
    .pill{
      padding:2px 10px;
      border:1px solid var(--grid);
      border-radius:999px;
      background: rgba(255,255,255,.04);
      font-weight:1000;
      color: rgba(255,255,255,.9);
      white-space:nowrap;
    }
    /* =========================
   MOBILE OPTIMIZATION
   Pegalo AL FINAL del <style>
========================= */

/* Evita zoom/scroll raro y mejora el tap */
html, body{
  width:100%;
  overflow-x:hidden;
  -webkit-text-size-adjust:100%;
  touch-action: manipulation;
}

.wrap{
  padding:16px;
}

/* Toolbar pegada arriba en mobile */
.toolbar{
  position: sticky;
  top: 0;
  z-index: 50;
  background: rgba(0,5,49,.92);
  backdrop-filter: blur(8px);
  padding: 10px 6px;
  border-radius: 18px;
}

/* Layout a 1 columna en celular */
@media (max-width: 900px){
  .layout{
    grid-template-columns: 1fr !important;
  }

  /* Títulos más chicos */
  .titleBar{ margin: 20px 0 6px 0; }
  .title{ font-size: 42px; border-radius: 18px; padding: 10px 12px; }
  .subtitle{ font-size: 22px; margin: 6px 0 14px 0; }

  /* Instrucciones compactas */
  .instrucciones{ font-size: 16px; }
  .instru2{ font-size: 16px; margin-bottom: 20px; }

  /* Footer más chico */
  .piepag{ font-size: 14px; padding: 6px 8px; }

  /* Controles apilados y grandes */
  .toolbar{
    gap: 8px;
  }
  button{
    font-size: 16px;
    padding: 12px 14px;
    border-radius: 18px;
  }
  .playersControl{
    width: 100%;
    justify-content: space-between;
    border-radius: 18px;
  }
  .playersControl label{
    font-size: 16px;
  }
  .playersControl select{
    font-size: 16px;   /* >=16 para evitar zoom iOS */
    height: 44px;      /* target grande */
    border-radius: 16px;
  }

  /* Tabla: meterla dentro de scroll horizontal */
  #tabla{
    display:block;             /* clave para overflow */
    overflow-x:auto;
    -webkit-overflow-scrolling: touch;
    border-radius: 14px;
  }

  /* Mantener la tabla usable */
  table.main{
    min-width: 950px;  /* ajusta si querés, depende de cuántos jugadores */
  }

  table.main th, table.main td{
    font-size: 16px;
    padding: 8px 6px;
  }

  /* Inputs/selects grandes y sin zoom */
  .nameInput{
    font-size: 22px;
    padding: 10px 8px;
    border-radius: 14px;
  }
  .roundInput{
    font-size: 14px;
    padding: 10px 10px;
    border-radius: 14px;
  }
  select{
    height: 44px;
    font-size: 16px;
    border-radius: 14px;
  }

  /* Ronda activa / próxima: más legible pero sin explotar el layout */
  .roundInput.roundActiveBig{
    font-size: 28px;
    transform: none;
  }
  .roundInput.roundNextBig{
    font-size: 18px;
  }

  /* Scoreboard abajo y no sticky (en mobile molesta) */
  .scoreboard{
    position: static;
    top:auto;
    border-width: 4px;
  }
  .scoreboardHeader{
    font-size: 20px;
    padding: 12px;
  }
  .scoreItem{
    font-size: 18px;
    padding: 12px;
  }
  .rank{
    width: 36px;
    height: 36px;
  }
}

/* ✅ Sticky first column (RONDAS) para mobile y desktop */
table.main td:first-child,
table.main th:first-child{
  position: sticky;
  left: 0;
  z-index: 4;
  background: rgba(0,5,49,.95);
  backdrop-filter: blur(6px);
}

/* En el header, un poco más arriba */
table.main thead th:first-child{
  z-index: 6;
}
  </style>
</head>
<body>
<div class="wrap">
  <div class="titleBar">
    <div class="title">PODRIDA CALCULATOR</div>
  </div>

  <div class="subtitle">DUC</div>

  <div class="instrucciones">INSTRUCCIONES:</div>
  <div class="instrucciones">• Definí jugadores y rondas con + / −.</div>
  <div class="instrucciones">• La ronda grande es la que se está jugando.</div>
  <div class="instrucciones">• El jugador con TOCA PEDIR elige su Pidió.</div>
  <div class="instrucciones">• REPARTE indica quién reparte esa ronda.</div>
  <div class="instrucciones">• Cuando termina la mano, completá Se llevó.</div>
  <div class="instrucciones">• Los puntos se calculan automáticamente.</div>
  <div class="instru2">• La siguiente ronda se activa sola.</div>

  <div class="toolbar">
    <div class="playersControl">
      <label for="playersSelect">¿Cantidad de jugadores?</label>
      <select id="playersSelect"></select>
    </div>

    <button id="addRoundBtn" type="button">+ Ronda</button>
    <button id="removeRoundBtn" type="button">− Ronda</button>

    <span style="flex:1"></span>
    <button id="saveBtn" type="button">Guardar</button>
    <button id="clearBtn" type="button">Reiniciar</button>
    <small>Made by M$4.</small>
  </div>

  <div class="layout">
    <div>
      <table id="tabla" class="main">
        <colgroup id="cols"></colgroup>
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
        <tfoot id="tfoot"></tfoot>
      </table>

      <div id="results" class="results">
        <h2>RESULTADOS FINALES</h2>
        <div id="winnerLine" class="winner"></div>
        <div id="secondLine" class="second"></div>
        <div id="thirdLine" class="third"></div>
        <div id="restLines" class="rest"></div>
      </div>

      <div class="piepag">skkr</div>
      <div class="piepag">Made by ***. Powerd by 777. GitHub: duc1709</div>
    </div>

    <aside class="scoreboard">
      <div class="scoreboardHeader">Puntajes (en vivo)</div>
      <div id="scoreList" class="scoreList"></div>
    </aside>
  </div>
</div>

<script>
  const STORAGE_KEY = "tabla_basa_v12";

  function normalizeRoundLabel(s){
    return String(s || "")
      .trim()
      .replace(/\s+/g, "")
      .replace(/siin+/gi, "sin");
  }

  function defaultRoundsForPlayers(p){
    const map = {
      2: ["2","4","6","8","10","12","12sin","12sin","11","9","7","5","3","1"],
      3: ["2","4","6","8","10","12","12sin","12sin","12sin","11","9","7","5","3","1"],
      4: ["2","4","6","8","10","12","12sin","12sin","12sin","12sin","11","9","7","5","3","1"],
      5: ["2","4","6","8","10","10sin","10sin","10sin","10sin","10sin","9","7","5","3","1"],
      6: ["2","4","6","8","8sin","8sin","8sin","8sin","8sin","8sin","9","7","5","3","1"],
      7: ["2","4","6","7","7sin","7sin","7sin","7sin","7sin","7sin","7sin","5","3","1"],
      8: ["2","4","6","6sin","6sin","6sin","6sin","6sin","6sin","6sin","6sin","5","3","1"],
      9: ["2","4","5","5sin","5sin","5sin","5sin","5sin","5sin","5sin","5sin","5sin","3","1"],
      10:["2","4","5","5sin","5sin","5sin","5sin","5sin","5sin","5sin","5sin","5sin","5sin","3","1"],
      11:["2","4","4sin","4sin","4sin","4sin","4sin","4sin","4sin","4sin","4sin","4sin","4sin","3","1"],
      12:["2","4","4sin","4sin","4sin","4sin","4sin","4sin","4sin","4sin","4sin","4sin","4sin","4sin","3","1"],
    };
    const rounds = map[p] || map[6];
    return rounds.map(normalizeRoundLabel);
  }

  function parseRoundCards(label){
    const n = parseInt(String(label), 10);
    return Number.isFinite(n) ? n : null;
  }

  // ✅ max dinámico por ronda (3 -> 3, 10sin -> 10)
  function maxForRound(r){
    const cards = parseRoundCards(state.roundLabels[r]);
    return (cards === null) ? 8 : cards;
  }

  // ✅ opciones 0..max
  function makeOptions0toMax(selected = "", max = 8, forbidden = null){
    const frag = document.createDocumentFragment();

    const empty = document.createElement("option");
    empty.value = "";
    empty.textContent = "";
    frag.appendChild(empty);

    const m = Math.max(0, Number(max) || 0);

    for(let i = 0; i <= m; i++){
      if(forbidden !== null && i === forbidden) continue;
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = String(i);
      if(String(i) === String(selected)) opt.selected = true;
      frag.appendChild(opt);
    }
    return frag;
  }

  function defaultState(playerCount = 6){
    const rounds = defaultRoundsForPlayers(playerCount);
    return {
      playerCount,
      names: Array(playerCount).fill(""),
      roundLabels: rounds.slice(),
      rows: rounds.map(() => ({
        players: Array(playerCount).fill(0).map(() => ({ pidio:"", llevo:"" }))
      }))
    };
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultState(6);
      const parsed = JSON.parse(raw);

      const pc = Number(parsed.playerCount);
      const playerCount = (Number.isFinite(pc) && pc >= 2 && pc <= 12) ? pc : 6;

      const st = defaultState(playerCount);

      if(Array.isArray(parsed.names)){
        st.names = parsed.names.slice(0, playerCount);
        while(st.names.length < playerCount) st.names.push("");
      }

      if(Array.isArray(parsed.roundLabels) && parsed.roundLabels.length >= 1){
        st.roundLabels = parsed.roundLabels.map(normalizeRoundLabel);
      }

      st.rows = st.roundLabels.map((_, r) => {
        const row = { players: Array(playerCount).fill(0).map(() => ({ pidio:"", llevo:"" })) };
        const srcRow = parsed.rows?.[r];
        if(srcRow?.players && Array.isArray(srcRow.players)){
          for(let p=0;p<Math.min(srcRow.players.length, playerCount);p++){
            row.players[p].pidio = srcRow.players[p].pidio ?? "";
            row.players[p].llevo = srcRow.players[p].llevo ?? "";
          }
        }
        return row;
      });

      return st;
    }catch{
      return defaultState(6);
    }
  }

  let state = loadState();

  const colsEl  = document.getElementById("cols");
  const theadEl = document.getElementById("thead");
  const tbodyEl = document.getElementById("tbody");
  const tfootEl = document.getElementById("tfoot");
  const scoreListEl = document.getElementById("scoreList");

  const resultsEl = document.getElementById("results");
  const winnerLine = document.getElementById("winnerLine");
  const secondLine = document.getElementById("secondLine");
  const thirdLine  = document.getElementById("thirdLine");
  const restLines  = document.getElementById("restLines");

  const playersSelect = document.getElementById("playersSelect");

  function persist(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function displayName(i){
    const n = (state.names[i] || "").trim();
    return n !== "" ? n : `Jugador ${i+1}`;
  }

  function scoreFor(pidioStr, llevoStr){
    if(pidioStr === "" || llevoStr === "") return null;
    const pidio = Number(pidioStr);
    const llevo = Number(llevoStr);
    if(Number.isNaN(pidio) || Number.isNaN(llevo)) return null;

    if(llevo === pidio){
      return 10 + 3 * llevo;
    }else{
      return -3 * Math.abs(llevo - pidio);
    }
  }

  function isRoundClosed(r){
    return state.rows[r].players.every(pl => pl.llevo !== "");
  }

  function allRoundsClosed(){
    return state.roundLabels.every((_, r) => isRoundClosed(r));
  }

  function lastClosedRoundIndex(){
    let last = -1;
    for(let r=0;r<state.roundLabels.length;r++){
      if(isRoundClosed(r)) last = r;
    }
    return last;
  }

  function starterIndexForRound(r){ return r % state.playerCount; }
  function lastBidderIndexForRound(r){
    return (starterIndexForRound(r) + state.playerCount - 1) % state.playerCount;
  }
  function bidOrderForRound(r){
    const P = state.playerCount;
    const start = starterIndexForRound(r);
    const order = [];
    for(let k=0;k<P;k++) order.push((start + k) % P);
    return order;
  }

  // ✅ actualiza select de "Se llevó"
  function updateLlevoSelectUI(r, p){
    const sel = tbodyEl.querySelector(`select[data-kind="llevo"][data-r="${r}"][data-p="${p}"]`);
    if(!sel) return;

    const current = state.rows[r].players[p].llevo;
    sel.innerHTML = "";
    sel.appendChild(makeOptions0toMax(current, maxForRound(r), null));
  }

  // ✅ actualiza select de "Pidió" (incluye forbidden para obligado)
  function updatePidioSelectUI(r, p, forbidden){
    const sel = tbodyEl.querySelector(`select[data-kind="pidio"][data-r="${r}"][data-p="${p}"]`);
    if(!sel) return;

    sel.classList.toggle("forcedHint", p === lastBidderIndexForRound(r));

    const current = state.rows[r].players[p].pidio;
    sel.innerHTML = "";
    sel.appendChild(makeOptions0toMax(current, maxForRound(r), forbidden));
  }

  // ✅ si cambia la etiqueta de la ronda, refresca rangos y limpia inválidos
  function refreshRowSelectRanges(r){
    const max = maxForRound(r);

    for(let p = 0; p < state.playerCount; p++){
      const pid = state.rows[r].players[p].pidio;
      const llev = state.rows[r].players[p].llevo;

      if(pid !== "" && Number(pid) > max) state.rows[r].players[p].pidio = "";
      if(llev !== "" && Number(llev) > max) state.rows[r].players[p].llevo = "";

      updatePidioSelectUI(r, p, null);
      updateLlevoSelectUI(r, p);
    }

    persist();
  }

  // Regla del obligado (último en pedir no puede dejar suma == cartas)
  function enforceBidConstraint(r){
    const cards = parseRoundCards(state.roundLabels[r]);
    if(cards === null){
      // si no hay número, no aplico obligado
      return;
    }

    const last = lastBidderIndexForRound(r);

    let sumOthers = 0;
    for(let p=0;p<state.playerCount;p++){
      if(p === last) continue;
      const v = state.rows[r].players[p].pidio;
      if(v === ""){
        updatePidioSelectUI(r, last, null);
        return;
      }
      sumOthers += Number(v);
    }

    const forbidden = cards - sumOthers;
    const max = maxForRound(r);

    if(forbidden >= 0 && forbidden <= max){
      if(state.rows[r].players[last].pidio !== "" && Number(state.rows[r].players[last].pidio) === forbidden){
        state.rows[r].players[last].pidio = "";
        persist();
      }
      updatePidioSelectUI(r, last, forbidden);
    }else{
      updatePidioSelectUI(r, last, null);
    }
  }

  function refreshAllConstraints(){
    for(let r=0; r<state.roundLabels.length; r++){
      enforceBidConstraint(r);
      for(let p=0; p<state.playerCount; p++){
        updatePidioSelectUI(r, p, null);
        updateLlevoSelectUI(r, p);
      }
    }
  }

  function getActiveRoundIndex(){
    for(let r=0;r<state.roundLabels.length;r++){
      if(!isRoundClosed(r)) return r;
    }
    return null;
  }

  function getNextRoundIndex(){
    const r = getActiveRoundIndex();
    if(r === null) return null;
    return (r + 1 < state.roundLabels.length) ? (r + 1) : null;
  }

  function getNextBidderInRound(r){
    const order = bidOrderForRound(r);
    for(const p of order){
      if(state.rows[r].players[p].pidio === "") return p;
    }
    return null;
  }

  function clearHighlights(){
    tbodyEl.querySelectorAll("select.turnActive").forEach(el => el.classList.remove("turnActive"));
    tbodyEl.querySelectorAll("td.roundActive").forEach(el => el.classList.remove("roundActive"));
    tbodyEl.querySelectorAll("input.roundInput").forEach(el => {
      el.classList.remove("roundActiveBig");
      el.classList.remove("roundNextBig");
    });
    tbodyEl.querySelectorAll("td.pts.turnText").forEach(el => el.classList.remove("turnText"));
    tbodyEl.querySelectorAll("td.pts.dealerText").forEach(el => el.classList.remove("dealerText"));
  }

  function updateHighlights(){
    clearHighlights();

    const r = getActiveRoundIndex();
    const nextR = getNextRoundIndex();
    if(r === null) return;

    const roundCell = tbodyEl.querySelector(`td[data-kind="round"][data-r="${r}"]`);
    if(roundCell) roundCell.classList.add("roundActive");

    const roundInput = tbodyEl.querySelector(`td[data-kind="round"][data-r="${r}"] input.roundInput`);
    if(roundInput) roundInput.classList.add("roundActiveBig");

    if(nextR !== null){
      const nextInput = tbodyEl.querySelector(`td[data-kind="round"][data-r="${nextR}"] input.roundInput`);
      if(nextInput) nextInput.classList.add("roundNextBig");
    }

    const nextBidder = getNextBidderInRound(r);
    if(nextBidder !== null){
      const sel = tbodyEl.querySelector(`select[data-kind="pidio"][data-r="${r}"][data-p="${nextBidder}"]`);
      if(sel) sel.classList.add("turnActive");

      const ptsBidder = tbodyEl.querySelector(`td.pts[data-r="${r}"][data-p="${nextBidder}"]`);
      if(ptsBidder){
        ptsBidder.textContent = "TOCA PEDIR";
        ptsBidder.classList.add("turnText");
        ptsBidder.classList.remove("neg","pos");
      }
    }

    const starter = starterIndexForRound(r);
    const dealer = (starter - 1 + state.playerCount) % state.playerCount;

    if(state.rows[r].players[starter].pidio === ""){
      const ptsDealer = tbodyEl.querySelector(`td.pts[data-r="${r}"][data-p="${dealer}"]`);
      if(ptsDealer){
        ptsDealer.textContent = "REPARTE";
        ptsDealer.classList.add("dealerText");
        ptsDealer.classList.remove("neg","pos");
      }
    }
  }

  function getTotals(){
    const P = state.playerCount;
    const R = state.roundLabels.length;
    const totals = Array(P).fill(0);

    for(let p=0;p<P;p++){
      let acc = 0;
      for(let r=0;r<R;r++){
        if(!isRoundClosed(r)) continue;
        const pidio = state.rows[r].players[p].pidio;
        const llevo = state.rows[r].players[p].llevo;
        const s = scoreFor(pidio, llevo);
        if(s !== null) acc += s;
      }
      totals[p] = acc;
    }
    return totals;
  }

  // Leaderboard en vivo (ordenado)
  function renderScoreList(){
    const totals = getTotals();

    const list = totals.map((pts, i) => ({
      i,
      pts,
      name: displayName(i),
    })).sort((a,b) => b.pts - a.pts);

    scoreListEl.innerHTML = "";

    for(let rank=0; rank<list.length; rank++){
      const row = list[rank];

      const item = document.createElement("div");
      item.className = "scoreItem";

      const left = document.createElement("div");
      left.className = "left";

      const rnk = document.createElement("div");
      rnk.className = "rank";
      rnk.textContent = `${rank+1}`;

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = row.name;

      left.appendChild(rnk);
      left.appendChild(name);

      const pts = document.createElement("div");
      pts.className = "ptsVal";
      pts.textContent = `${row.pts} pts`;

      item.appendChild(left);
      item.appendChild(pts);
      scoreListEl.appendChild(item);
    }
  }

  function buildPlayersSelect(){
    playersSelect.innerHTML = "";
    for(let i=2;i<=12;i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = String(i);
      if(i === state.playerCount) opt.selected = true;
      playersSelect.appendChild(opt);
    }
  }

  function setPlayerCount(newCount){
    const n = Number(newCount);
    if(!Number.isFinite(n) || n < 2 || n > 12) return;

    const keepNames = state.names.slice(0, Math.min(state.playerCount, n));
    while(keepNames.length < n) keepNames.push("");

    const fresh = defaultState(n);
    fresh.names = keepNames;

    state = fresh;
    persist();
    buildPlayersSelect();
    buildTable();
  }

  function buildTable(){
    const P = state.playerCount;
    const R = state.roundLabels.length;

    colsEl.innerHTML = "";
    const cCC = document.createElement("col");
    cCC.className = "cc";
    colsEl.appendChild(cCC);

    for(let p=0;p<P;p++){
      const cPi = document.createElement("col"); cPi.className = "pidio";
      const cL  = document.createElement("col"); cL.className  = "llevo";
      const cPts= document.createElement("col"); cPts.className= "puntos";
      colsEl.appendChild(cPi);
      colsEl.appendChild(cL);
      colsEl.appendChild(cPts);
    }

    theadEl.innerHTML = "";

    const trNames = document.createElement("tr");
    const thEmpty = document.createElement("th");
    thEmpty.textContent = "";
    thEmpty.classList.add("topThick");
    trNames.appendChild(thEmpty);

    for(let p=0;p<P;p++){
      const th = document.createElement("th");
      th.colSpan = 3;
      th.classList.add("topThick","sepL");
      if(p === P-1) th.classList.add("sepR");

      const input = document.createElement("input");
      input.className = "nameInput";
      input.placeholder = `Jugador ${p+1}`;
      input.value = state.names[p] || "";
      input.addEventListener("input", () => {
        state.names[p] = input.value;
        persist();
        renderScoreList();
        updateFinalResults();
      });

      th.appendChild(input);
      trNames.appendChild(th);
    }
    theadEl.appendChild(trNames);

    const trHead = document.createElement("tr");
    const thCC = document.createElement("th");
    thCC.textContent = "RONDAS";
    thCC.classList.add("bottomThick");
    trHead.appendChild(thCC);

    for(let p=0;p<P;p++){
      const thPi = document.createElement("th");
      thPi.textContent = "Pidió";
      thPi.classList.add("sepL","bottomThick");

      const thL = document.createElement("th");
      thL.textContent = "Se llevó";
      thL.classList.add("bottomThick");

      const thPts = document.createElement("th");
      thPts.textContent = "Puntos";
      thPts.classList.add("bottomThick");
      if(p === P-1) thPts.classList.add("sepR");

      trHead.appendChild(thPi);
      trHead.appendChild(thL);
      trHead.appendChild(thPts);
    }
    theadEl.appendChild(trHead);

    tbodyEl.innerHTML = "";

    for(let r=0;r<R;r++){
      const tr = document.createElement("tr");

      const tdCC = document.createElement("td");
      tdCC.dataset.kind = "round";
      tdCC.dataset.r = String(r);

      const roundInput = document.createElement("input");
      roundInput.className = "roundInput";
      roundInput.value = state.roundLabels[r];
      roundInput.addEventListener("input", () => {
        state.roundLabels[r] = normalizeRoundLabel(roundInput.value);
        roundInput.value = state.roundLabels[r];

        // ✅ refresca rangos 0..cartas en esa fila
        refreshRowSelectRanges(r);

        enforceBidConstraint(r);
        recalcAndRender();
        renderScoreList();
        updateHighlights();
        updateFinalResults();
      });

      tdCC.appendChild(roundInput);
      tr.appendChild(tdCC);

      for(let p=0;p<P;p++){
        const tdPi = document.createElement("td");
        tdPi.classList.add("sepL");

        const selPi = document.createElement("select");
        selPi.classList.add("pidioSel");
        selPi.dataset.kind = "pidio";
        selPi.dataset.r = String(r);
        selPi.dataset.p = String(p);
        selPi.appendChild(makeOptions0toMax(state.rows[r].players[p].pidio, maxForRound(r), null));
        selPi.addEventListener("change", () => {
          state.rows[r].players[p].pidio = selPi.value;
          persist();
          enforceBidConstraint(r);
          recalcAndRender();
          renderScoreList();
          updateHighlights();
          updateFinalResults();
        });
        tdPi.appendChild(selPi);

        const tdL = document.createElement("td");
        const selL = document.createElement("select");
        selL.classList.add("llevoSel");
        selL.dataset.kind = "llevo";
        selL.dataset.r = String(r);
        selL.dataset.p = String(p);
        selL.appendChild(makeOptions0toMax(state.rows[r].players[p].llevo, maxForRound(r), null));
        selL.addEventListener("change", () => {
          state.rows[r].players[p].llevo = selL.value;
          persist();
          recalcAndRender();
          renderScoreList();
          updateHighlights();
          updateFinalResults();
        });
        tdL.appendChild(selL);

        const tdPts = document.createElement("td");
        tdPts.className = "pts";
        tdPts.dataset.r = String(r);
        tdPts.dataset.p = String(p);
        if(p === P-1) tdPts.classList.add("sepR");

        tr.appendChild(tdPi);
        tr.appendChild(tdL);
        tr.appendChild(tdPts);
      }

      tbodyEl.appendChild(tr);
    }

    tfootEl.innerHTML = "";
    const trTotal = document.createElement("tr");
    const tdTotalLabel = document.createElement("td");
    tdTotalLabel.textContent = "TOTAL";
    tdTotalLabel.className = "totalLabel";
    trTotal.appendChild(tdTotalLabel);

    for(let p=0;p<P;p++){
      const td = document.createElement("td");
      td.colSpan = 3;
      td.classList.add("totalBox","sepL");
      if(p === P-1) td.classList.add("sepR");
      td.dataset.totalFor = String(p);
      td.textContent = "0";
      trTotal.appendChild(td);
    }
    tfootEl.appendChild(trTotal);

    refreshAllConstraints();
    recalcAndRender();
    renderScoreList();
    updateHighlights();
    updateFinalResults();
  }

  function recalcAndRender(){
    const P = state.playerCount;
    const R = state.roundLabels.length;
    const lastClosed = lastClosedRoundIndex();

    const activeR = getActiveRoundIndex();
    const nextBidder = (activeR !== null) ? getNextBidderInRound(activeR) : null;

    const starter = (activeR !== null) ? starterIndexForRound(activeR) : null;
    const dealer = (activeR !== null) ? ((starter - 1 + P) % P) : null;

    for(let r=0;r<R;r++){
      for(let p=0;p<P;p++){
        const cell = tbodyEl.querySelector(`td.pts[data-r="${r}"][data-p="${p}"]`);
        if(!cell) continue;

        const isTurnCell =
          (activeR === r && nextBidder === p && state.rows[r].players[p].pidio === "");

        const isDealerCell =
          (activeR === r && dealer === p && starter !== null && state.rows[r].players[starter].pidio === "");

        if(isTurnCell || isDealerCell){
          continue;
        }

        cell.classList.remove("turnText","dealerText");

        if(r > lastClosed){
          cell.textContent = "";
          cell.classList.remove("neg","pos");
          continue;
        }

        let acc = 0;
        for(let rr=0; rr<=r; rr++){
          if(!isRoundClosed(rr)) continue;
          const pidio = state.rows[rr].players[p].pidio;
          const llevo = state.rows[rr].players[p].llevo;
          const s = scoreFor(pidio, llevo);
          if(s !== null) acc += s;
        }

        cell.textContent = String(acc);
        cell.classList.remove("neg","pos");
        if(acc < 0) cell.classList.add("neg");
        if(acc > 0) cell.classList.add("pos");
      }
    }

    for(let p=0;p<P;p++){
      let acc = 0;
      for(let r=0;r<R;r++){
        if(!isRoundClosed(r)) continue;
        const pidio = state.rows[r].players[p].pidio;
        const llevo = state.rows[r].players[p].llevo;
        const s = scoreFor(pidio, llevo);
        if(s !== null) acc += s;
      }
      const td = tfootEl.querySelector(`[data-total-for="${p}"]`);
      if(td) td.textContent = String(acc);
    }
  }

  function updateFinalResults(){
    if(!allRoundsClosed()){
      resultsEl.classList.remove("show");
      return;
    }

    const totals = getTotals();
    const list = totals.map((pts, i) => ({ i, pts, name: displayName(i) }))
      .sort((a,b) => b.pts - a.pts);

    resultsEl.classList.add("show");

    winnerLine.textContent = list[0] ? `1º ${list[0].name} — ${list[0].pts} pts` : "";
    secondLine.textContent = list[1] ? `2º ${list[1].name} — ${list[1].pts} pts` : "";
    thirdLine.textContent  = list[2] ? `3º ${list[2].name} — ${list[2].pts} pts` : "";

    restLines.innerHTML = "";
    for(let k=3;k<list.length;k++){
      const row = document.createElement("div");
      row.className = "rowLine";

      const left = document.createElement("div");
      left.textContent = `${k+1}º ${list[k].name}`;

      const right = document.createElement("div");
      right.className = "pill";
      right.textContent = `${list[k].pts} pts`;

      row.appendChild(left);
      row.appendChild(right);
      restLines.appendChild(row);
    }
  }

  // + Ronda / - Ronda se mantienen
  function addRound(){
    const P = state.playerCount;
    state.roundLabels.push("Nueva");
    state.rows.push({ players: Array(P).fill(0).map(() => ({ pidio:"", llevo:"" })) });
    persist();
    buildTable();
  }
  function removeRound(){
    if(state.roundLabels.length <= 1) return;
    state.roundLabels.pop();
    state.rows.pop();
    persist();
    buildTable();
  }

  document.getElementById("addRoundBtn").addEventListener("click", addRound);
  document.getElementById("removeRoundBtn").addEventListener("click", removeRound);

  document.getElementById("saveBtn").addEventListener("click", () => {
    persist();
    alert("Guardado ✅");
  });

  document.getElementById("clearBtn").addEventListener("click", () => {
    if(!confirm("¿Seguro que querés reiniciar la partida?")) return;
    localStorage.removeItem(STORAGE_KEY);
    state = defaultState(state.playerCount);
    persist();
    buildPlayersSelect();
    buildTable();
  });

  // init
  buildPlayersSelect();
  playersSelect.addEventListener("change", (e) => setPlayerCount(e.target.value));

  buildTable();
  window.addEventListener("beforeunload", persist);
</script>
</body>
</html>
celular